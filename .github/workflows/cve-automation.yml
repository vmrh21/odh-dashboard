name: CVE Auto-Fix for odh-dashboard

# This workflow triggers CVE discovery and fixing for the odh-dashboard repository
# It creates an Ambient session that runs in the background
# The workflow completes immediately after creating the session (fire-and-forget)
# Pull requests will be created automatically by the background session

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      run_find:
        description: 'Run CVE find step'
        required: true
        default: true
        type: boolean

      run_fix:
        description: 'Run CVE fix step'
        required: true
        default: true
        type: boolean

      component:
        description: 'Component name'
        required: true
        default: 'AI Core Dashboard'
        type: string

  # Optional: Scheduled weekly scan (uncomment to enable)
  # schedule:
  #   - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC

jobs:
  cve-automation:
    name: CVE Automation (Find & Fix)
    runs-on: ubuntu-latest

    steps:
      - name: Build Prompt for Ambient Session
        id: build-prompt
        env:
          RUN_FIND: ${{ github.event.inputs.run_find }}
          RUN_FIX: ${{ github.event.inputs.run_fix }}
          COMPONENT: ${{ github.event.inputs.component || 'AI Core Dashboard' }}
        run: |
          PROMPT=""

          # Build prompt based on what steps to run
          if [ "$RUN_FIND" = "true" ] && [ "$RUN_FIX" = "true" ]; then
            # Both find and fix - run automatically without asking
            PROMPT="/cve.find --component '${COMPONENT}'"$'\n\n'"After /cve.find completes, automatically run /cve.fix without asking for confirmation."
          elif [ "$RUN_FIND" = "true" ]; then
            # Only find
            PROMPT="/cve.find --component '${COMPONENT}'"
          elif [ "$RUN_FIX" = "true" ]; then
            # Only fix
            PROMPT="/cve.fix"
          fi

          # Save prompt to output (escape for multiline)
          {
            echo 'prompt<<EOF'
            echo "$PROMPT"
            echo EOF
          } >> $GITHUB_OUTPUT

          echo "### ðŸ“ Session Prompt" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$PROMPT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Run CVE Automation Session
        id: cve-session
        uses: ambient-code/ambient-action@v0.0.2
        with:
          api-url: ${{ secrets.AMBIENT_API_URL }}
          api-token: ${{ secrets.AMBIENT_API_TOKEN }}
          project: new
          prompt: ${{ steps.build-prompt.outputs.prompt }}
          workflow: |
            {
              "gitUrl": "https://github.com/angaduom/workflows.git",
              "branch": "test-configuration",
              "path": "workflows/cve-fixer"
            }
          display-name: "CVE Automation - ${{ github.event.inputs.component || 'AI Core Dashboard' }} (Run ${{ github.run_id }})"
          timeout: 4500
          wait: false

      - name: Session Created
        env:
          SESSION_NAME: ${{ steps.cve-session.outputs.session-name }}
          COMPONENT: ${{ github.event.inputs.component || 'AI Core Dashboard' }}
        run: |
          echo "### ðŸš€ CVE Automation Session Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Session \`${SESSION_NAME}\` has been created and is running in the background." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Component:** ${COMPONENT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**What's happening:**" >> $GITHUB_STEP_SUMMARY
          echo "- The session is running CVE find and fix commands" >> $GITHUB_STEP_SUMMARY
          echo "- Pull requests will be created automatically when fixes are ready" >> $GITHUB_STEP_SUMMARY
          echo "- Check the [Pull Requests](https://github.com/${{ github.repository }}/pulls) tab for CVE fixes" >> $GITHUB_STEP_SUMMARY
          echo "- View session logs in the Ambient Platform UI" >> $GITHUB_STEP_SUMMARY
