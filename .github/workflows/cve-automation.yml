name: CVE Auto-Fix for odh-dashboard

# This workflow runs CVE discovery and fixing for the odh-dashboard repository
# It uses the CVE fixer workflow from angaduom/workflows (no duplication)

on:
  # Manual trigger with optional Jira filtering
  workflow_dispatch:
    inputs:
      run_find:
        description: 'Run CVE find step'
        required: true
        default: true
        type: boolean

      run_fix:
        description: 'Run CVE fix step'
        required: true
        default: true
        type: boolean

      component:
        description: 'Component name'
        required: true
        default: 'AI Core Dashboard'
        type: string

      jira_include:
        description: 'Jira issues to INCLUDE (comma-separated, e.g., RHOAIENG-12345,RHOAIENG-67890). Leave empty to include all.'
        required: false
        type: string

      jira_exclude:
        description: 'Jira issues to EXCLUDE (comma-separated, e.g., RHOAIENG-99999). Leave empty to exclude none.'
        required: false
        type: string

  # Optional: Scheduled weekly scan (uncomment to enable)
  # schedule:
  #   - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC

jobs:
  cve-find:
    name: Find CVEs in Jira
    runs-on: ubuntu-latest
    # Only run if user wants find step
    if: ${{ github.event.inputs.run_find == 'true' || github.event_name == 'schedule' }}

    outputs:
      session_name: ${{ steps.create-find-session.outputs.session_name }}
      find_status: ${{ steps.monitor-find.outputs.status }}

    steps:
      - name: Install OpenShift CLI
        run: |
          echo "Installing OpenShift CLI..."
          curl -sLO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc /usr/local/bin/
          sudo chmod +x /usr/local/bin/oc
          oc version --client

      - name: Login to OpenShift Cluster
        env:
          OC_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
          OC_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
        run: |
          echo "Logging into OpenShift cluster..."
          oc login --token="${OC_TOKEN}" --server="${OC_SERVER}"
          echo "âœ… Logged in as: $(oc whoami)"
          oc project cve-automation-test

      - name: Create CVE Find Session
        id: create-find-session
        env:
          COMPONENT: ${{ github.event.inputs.component || 'AI Core Dashboard' }}
          RUN_ID: ${{ github.run_id }}
          REPO_NAME: ${{ github.repository }}
        run: |
          SESSION_NAME="cve-find-${RUN_ID}"

          echo "Creating CVE Find session..."
          echo "  Session: ${SESSION_NAME}"
          echo "  Component: ${COMPONENT}"
          echo "  Repository: ${REPO_NAME}"

          cat > session-find.yaml <<EOF
          apiVersion: vteam.ambient-code/v1alpha1
          kind: AgenticSession
          metadata:
            name: ${SESSION_NAME}
            namespace: cve-automation-test
            labels:
              workflow: cve-automation
              repository: odh-dashboard
              step: find
              github-run-id: "${RUN_ID}"
          spec:
            displayName: "CVE Find - ${COMPONENT}"
            prompt: "/cve.find --component '${COMPONENT}'"
            activeWorkflow:
              gitUrl: "https://github.com/angaduom/workflows.git"
              branch: "test-configuration"
              path: "workflows/cve-fixer"
            interactive: false
            timeout: 900
            llmSettings:
              model: "claude-sonnet-4-5"
              maxTokens: 4000
          EOF

          oc apply -f session-find.yaml
          echo "session_name=${SESSION_NAME}" >> $GITHUB_OUTPUT

          echo "### ðŸ” CVE Find Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Session** | \`${SESSION_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Component** | ${COMPONENT} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Repository** | ${REPO_NAME} |" >> $GITHUB_STEP_SUMMARY

      - name: Monitor CVE Find Session
        id: monitor-find
        env:
          SESSION_NAME: ${{ steps.create-find-session.outputs.session_name }}
        run: |
          echo "Monitoring CVE find session: ${SESSION_NAME}"

          MAX_ITERATIONS=30
          ITERATION=0
          LAST_PHASE=""

          while [ $ITERATION -lt $MAX_ITERATIONS ]; do
            PHASE=$(oc get agenticsession ${SESSION_NAME} -n cve-automation-test -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")

            if [ "$PHASE" != "$LAST_PHASE" ]; then
              echo "[$(date +'%H:%M:%S')] Phase: ${PHASE}"
              LAST_PHASE=$PHASE
            fi

            if [ "$PHASE" = "Succeeded" ]; then
              echo "âœ… CVE find completed successfully"
              echo "status=succeeded" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âœ… CVE Find Completed" >> $GITHUB_STEP_SUMMARY
              echo "Found CVE issues in Jira for component." >> $GITHUB_STEP_SUMMARY
              exit 0
            elif [ "$PHASE" = "Failed" ]; then
              echo "âŒ CVE find failed"
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âŒ CVE Find Failed" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi

            sleep 30
            ITERATION=$((ITERATION + 1))
          done

          echo "âš ï¸ Timeout waiting for CVE find"
          echo "status=timeout" >> $GITHUB_OUTPUT
          exit 1

  cve-fix:
    name: Fix CVEs
    runs-on: ubuntu-latest
    needs: [cve-find]
    # Run if user wants fix AND (find succeeded OR find was skipped)
    if: |
      always() &&
      github.event.inputs.run_fix == 'true' &&
      (needs.cve-find.outputs.find_status == 'succeeded' || github.event.inputs.run_find == 'false')

    outputs:
      session_name: ${{ steps.create-fix-session.outputs.session_name }}
      fix_status: ${{ steps.monitor-fix.outputs.status }}

    steps:
      - name: Install OpenShift CLI
        run: |
          echo "Installing OpenShift CLI..."
          curl -sLO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc /usr/local/bin/
          sudo chmod +x /usr/local/bin/oc
          oc version --client

      - name: Login to OpenShift Cluster
        env:
          OC_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
          OC_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
        run: |
          echo "Logging into OpenShift cluster..."
          oc login --token="${OC_TOKEN}" --server="${OC_SERVER}"
          echo "âœ… Logged in as: $(oc whoami)"
          oc project cve-automation-test

      - name: Create CVE Fix Session
        id: create-fix-session
        env:
          COMPONENT: ${{ github.event.inputs.component || 'AI Core Dashboard' }}
          JIRA_INCLUDE: ${{ github.event.inputs.jira_include }}
          JIRA_EXCLUDE: ${{ github.event.inputs.jira_exclude }}
          RUN_ID: ${{ github.run_id }}
          REPO_NAME: ${{ github.repository }}
        run: |
          SESSION_NAME="cve-fix-${RUN_ID}"

          # Build the prompt with natural language Jira filtering
          PROMPT="/cve.fix --component '${COMPONENT}'"

          # Add include filter if provided (natural language)
          if [ -n "${JIRA_INCLUDE}" ]; then
            PROMPT="${PROMPT}. IMPORTANT: Only fix these Jira issues: ${JIRA_INCLUDE}. Ignore all other CVEs."
          fi

          # Add exclude filter if provided (natural language)
          if [ -n "${JIRA_EXCLUDE}" ]; then
            PROMPT="${PROMPT}. Do not fix these Jira issues: ${JIRA_EXCLUDE}. Fix all other CVEs."
          fi

          echo "Creating CVE Fix session..."
          echo "  Session: ${SESSION_NAME}"
          echo "  Component: ${COMPONENT}"
          echo "  Repository: ${REPO_NAME}"
          echo "  Prompt: ${PROMPT}"

          cat > session-fix.yaml <<EOF
          apiVersion: vteam.ambient-code/v1alpha1
          kind: AgenticSession
          metadata:
            name: ${SESSION_NAME}
            namespace: cve-automation-test
            labels:
              workflow: cve-automation
              repository: odh-dashboard
              step: fix
              github-run-id: "${RUN_ID}"
          spec:
            displayName: "CVE Fix - ${COMPONENT}"
            prompt: "${PROMPT}"
            activeWorkflow:
              gitUrl: "https://github.com/angaduom/workflows.git"
              branch: "test-configuration"
              path: "workflows/cve-fixer"
            interactive: false
            timeout: 3600
            llmSettings:
              model: "claude-sonnet-4-5"
              maxTokens: 4000
          EOF

          oc apply -f session-fix.yaml
          echo "session_name=${SESSION_NAME}" >> $GITHUB_OUTPUT

          echo "### ðŸ”§ CVE Fix Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Session** | \`${SESSION_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Component** | ${COMPONENT} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Repository** | ${REPO_NAME} |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${JIRA_INCLUDE}" ]; then
            echo "| **Include Jira** | ${JIRA_INCLUDE} |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${JIRA_EXCLUDE}" ]; then
            echo "| **Exclude Jira** | ${JIRA_EXCLUDE} |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Monitor CVE Fix Session
        id: monitor-fix
        env:
          SESSION_NAME: ${{ steps.create-fix-session.outputs.session_name }}
        run: |
          echo "Monitoring CVE fix session: ${SESSION_NAME}"

          MAX_ITERATIONS=120
          ITERATION=0
          LAST_PHASE=""

          while [ $ITERATION -lt $MAX_ITERATIONS ]; do
            PHASE=$(oc get agenticsession ${SESSION_NAME} -n cve-automation-test -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")

            if [ "$PHASE" != "$LAST_PHASE" ]; then
              echo "[$(date +'%H:%M:%S')] Phase: ${PHASE}"
              LAST_PHASE=$PHASE
            fi

            if [ "$PHASE" = "Succeeded" ]; then
              echo "âœ… CVE fix completed successfully"
              echo "status=succeeded" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âœ… CVE Fix Completed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Duration**: $((ITERATION * 30)) seconds" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… Pull requests created in odh-dashboard repository" >> $GITHUB_STEP_SUMMARY
              echo "âœ… Check the [Pull Requests](https://github.com/${GITHUB_REPOSITORY}/pulls) tab for CVE fixes" >> $GITHUB_STEP_SUMMARY
              exit 0
            elif [ "$PHASE" = "Failed" ]; then
              echo "âŒ CVE fix failed"
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âŒ CVE Fix Failed" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi

            if [ $((ITERATION % 10)) -eq 0 ] && [ $ITERATION -gt 0 ]; then
              echo "[$(date +'%H:%M:%S')] Still running... ($((ITERATION * 30 / 60)) minutes elapsed)"
            fi

            sleep 30
            ITERATION=$((ITERATION + 1))
          done

          echo "âš ï¸ Timeout waiting for CVE fix"
          echo "status=timeout" >> $GITHUB_OUTPUT
          exit 1

      - name: Get Session Logs (on failure)
        if: failure()
        env:
          SESSION_NAME: ${{ steps.create-fix-session.outputs.session_name }}
        run: |
          echo "=== Session Description ==="
          oc describe agenticsession ${SESSION_NAME} -n cve-automation-test || true

          echo ""
          echo "=== Pod Logs (last 100 lines) ==="
          POD_NAME=$(oc get pods -n cve-automation-test -l ambient-session=${SESSION_NAME} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          if [ -n "$POD_NAME" ]; then
            oc logs ${POD_NAME} -n cve-automation-test --tail=100 || true
          fi
