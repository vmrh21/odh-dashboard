name: CVE Auto-Fix for odh-dashboard

# This workflow runs CVE discovery and fixing for the odh-dashboard repository
# It uses the CVE fixer workflow from angaduom/workflows via ambient-action

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      run_find:
        description: 'Run CVE find step'
        required: true
        default: true
        type: boolean

      run_fix:
        description: 'Run CVE fix step'
        required: true
        default: true
        type: boolean

      component:
        description: 'Component name'
        required: true
        default: 'AI Core Dashboard'
        type: string

  # Optional: Scheduled weekly scan (uncomment to enable)
  # schedule:
  #   - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC

jobs:
  cve-automation:
    name: CVE Automation (Find & Fix)
    runs-on: ubuntu-latest

    steps:
      - name: Build Prompt for Ambient Session
        id: build-prompt
        env:
          RUN_FIND: ${{ github.event.inputs.run_find }}
          RUN_FIX: ${{ github.event.inputs.run_fix }}
          COMPONENT: ${{ github.event.inputs.component || 'AI Core Dashboard' }}
        run: |
          PROMPT=""

          # Build prompt based on what steps to run
          if [ "$RUN_FIND" = "true" ] && [ "$RUN_FIX" = "true" ]; then
            # Both find and fix - run automatically without asking
            PROMPT="/cve.find --component '${COMPONENT}'"$'\n\n'"After /cve.find completes, automatically run /cve.fix without asking for confirmation."
          elif [ "$RUN_FIND" = "true" ]; then
            # Only find
            PROMPT="/cve.find --component '${COMPONENT}'"
          elif [ "$RUN_FIX" = "true" ]; then
            # Only fix
            PROMPT="/cve.fix"
          fi

          # Save prompt to output (escape for multiline)
          {
            echo 'prompt<<EOF'
            echo "$PROMPT"
            echo EOF
          } >> $GITHUB_OUTPUT

          echo "### ðŸ“ Session Prompt" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$PROMPT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Create CVE Automation Session
        id: cve-session
        uses: ambient-code/ambient-action@v0.0.2
        with:
          api-url: ${{ secrets.AMBIENT_API_URL }}
          api-token: ${{ secrets.AMBIENT_API_TOKEN }}
          project: new
          prompt: ${{ steps.build-prompt.outputs.prompt }}
          workflow: |
            {
              "gitUrl": "https://github.com/angaduom/workflows.git",
              "branch": "test-configuration",
              "path": "workflows/cve-fixer"
            }
          display-name: "CVE Automation - ${{ github.event.inputs.component || 'AI Core Dashboard' }} (Run ${{ github.run_id }})"
          timeout: 4500
          wait: false

      - name: Install OpenShift CLI
        run: |
          wget https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc /usr/local/bin/
          sudo chmod +x /usr/local/bin/oc
          oc version --client

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Login to OpenShift
        env:
          OC_TOKEN: ${{ secrets.AMBIENT_API_TOKEN }}
          OC_SERVER: https://api.vteam-uat.0ksl.p3.openshiftapps.com:443
        run: |
          oc login --token=${OC_TOKEN} --server=${OC_SERVER}
          oc project new

      - name: Monitor Session for Completion
        env:
          SESSION_NAME_FROM_ACTION: ${{ steps.cve-session.outputs.session-name }}
          RUN_ID: ${{ github.run_id }}
          RUN_FIND: ${{ github.event.inputs.run_find }}
          RUN_FIX: ${{ github.event.inputs.run_fix }}
          COMPONENT: ${{ github.event.inputs.component || 'AI Core Dashboard' }}
        run: |
          # Find session by display name if ambient-action didn't return session-name
          if [ -n "$SESSION_NAME_FROM_ACTION" ]; then
            SESSION_NAME="$SESSION_NAME_FROM_ACTION"
            echo "Using session from ambient-action output: ${SESSION_NAME}"
          else
            echo "Session name not returned by ambient-action, searching by display name..."
            DISPLAY_NAME="CVE Automation - ${COMPONENT} (Run ${RUN_ID})"
            echo "Looking for session with display name: ${DISPLAY_NAME}"

            # Wait for session to be created (up to 2 minutes)
            for i in {1..60}; do
              SESSION_NAME=$(oc get agenticsessions -n new -o json | jq -r ".items[] | select(.spec.displayName == \"${DISPLAY_NAME}\") | .metadata.name" 2>/dev/null || echo "")
              if [ -n "$SESSION_NAME" ]; then
                echo "Found session: ${SESSION_NAME}"
                break
              fi
              echo "Waiting for session to be created... (${i}/60)"
              sleep 2
            done

            if [ -z "$SESSION_NAME" ]; then
              echo "Error: Session not found after 2 minutes"
              exit 1
            fi
          fi

          echo "Monitoring session: ${SESSION_NAME}"

          # Wait for pod to be created (up to 3 minutes)
          echo "Waiting for session pod to start..."
          POD_NAME=""
          for i in {1..90}; do
            POD_NAME=$(oc get pods -n new -l agentic-session=${SESSION_NAME} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
            if [ -n "$POD_NAME" ]; then
              echo "Pod found: ${POD_NAME}"
              break
            fi
            echo "Waiting for pod... (${i}/90)"
            sleep 2
          done

          if [ -z "$POD_NAME" ]; then
            echo "Error: Pod not found after 3 minutes"
            echo "Checking session status..."
            oc get agenticsession ${SESSION_NAME} -n new -o yaml | grep -A 10 "status:"
            exit 1
          fi

          # Wait for pod to be running (up to 5 minutes)
          echo "Waiting for pod to be ready..."
          oc wait --for=condition=Ready pod/${POD_NAME} -n new --timeout=300s

          # Monitor logs for completion
          echo "Monitoring logs for completion markers..."
          FIND_COMPLETE=false
          FIX_COMPLETE=false
          TIMEOUT=4500

          timeout ${TIMEOUT} oc logs -f ${POD_NAME} -c runner -n new 2>&1 | while IFS= read -r line; do
            echo "$line"

            # Check for find completion
            if [[ "$line" =~ (Results saved to:|cve-issues-.*\.md|Found.*CVE issues) ]]; then
              echo ""
              echo "âœ… Find Completed"
              echo ""
              FIND_COMPLETE=true
            fi

            # Check for fix completion
            if [[ "$line" =~ (pr-creation-summary\.md|All PRs created|created successfully) ]]; then
              echo ""
              echo "âœ… Fix Completed"
              echo ""
              FIX_COMPLETE=true
            fi

            # Exit when done
            if [ "$RUN_FIND" = "true" ] && [ "$RUN_FIX" = "true" ]; then
              if [ "$FIX_COMPLETE" = "true" ]; then
                echo "ðŸŽ‰ Both find and fix completed successfully!"
                exit 0
              fi
            elif [ "$RUN_FIND" = "true" ] && [ "$FIND_COMPLETE" = "true" ]; then
              echo "ðŸŽ‰ Find completed successfully!"
              exit 0
            elif [ "$RUN_FIX" = "true" ] && [ "$FIX_COMPLETE" = "true" ]; then
              echo "ðŸŽ‰ Fix completed successfully!"
              exit 0
            fi
          done

      - name: Report Results
        if: always()
        env:
          SESSION_NAME_FROM_ACTION: ${{ steps.cve-session.outputs.session-name }}
          SESSION_UID: ${{ steps.cve-session.outputs.session-uid }}
          COMPONENT: ${{ github.event.inputs.component || 'AI Core Dashboard' }}
          RUN_ID: ${{ github.run_id }}
          RUN_FIND: ${{ github.event.inputs.run_find }}
          RUN_FIX: ${{ github.event.inputs.run_fix }}
        run: |
          # Find session name (same logic as monitor step)
          if [ -n "$SESSION_NAME_FROM_ACTION" ]; then
            SESSION_NAME="$SESSION_NAME_FROM_ACTION"
          else
            DISPLAY_NAME="CVE Automation - ${COMPONENT} (Run ${RUN_ID})"
            SESSION_NAME=$(oc get agenticsessions -n new -o json | jq -r ".items[] | select(.spec.displayName == \"${DISPLAY_NAME}\") | .metadata.name" 2>/dev/null || echo "Unknown")
          fi

          echo "### ðŸ¤– CVE Automation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Session Name** | \`${SESSION_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Session UID** | \`${SESSION_UID:-Unknown}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Component** | ${COMPONENT} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Repository** | ${{ github.repository }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Find Step** | $([ "$RUN_FIND" = "true" ] && echo "âœ… Completed" || echo "â­ï¸ Skipped") |" >> $GITHUB_STEP_SUMMARY
          echo "| **Fix Step** | $([ "$RUN_FIX" = "true" ] && echo "âœ… Completed" || echo "â­ï¸ Skipped") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Workflow Completed Successfully" >> $GITHUB_STEP_SUMMARY

          if [ "$RUN_FIX" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Pull requests may have been created in the repository" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Check the [Pull Requests](https://github.com/${{ github.repository }}/pulls) tab for CVE fixes" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** The Ambient session remains running for log access. You can view it at:" >> $GITHUB_STEP_SUMMARY
          echo "\`${SESSION_NAME}\`" >> $GITHUB_STEP_SUMMARY
