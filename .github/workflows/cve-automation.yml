name: CVE Auto-Fix for odh-dashboard

# This workflow runs CVE discovery and fixing for the odh-dashboard repository
# It uses the CVE fixer workflow from angaduom/workflows via ambient-action

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      run_find:
        description: 'Run CVE find step'
        required: true
        default: true
        type: boolean

      run_fix:
        description: 'Run CVE fix step'
        required: true
        default: true
        type: boolean

      component:
        description: 'Component name'
        required: true
        default: 'AI Core Dashboard'
        type: string

  # Optional: Scheduled weekly scan (uncomment to enable)
  # schedule:
  #   - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC

jobs:
  cve-automation:
    name: CVE Automation (Find & Fix)
    runs-on: ubuntu-latest

    steps:
      - name: Build Prompt for Ambient Session
        id: build-prompt
        env:
          RUN_FIND: ${{ github.event.inputs.run_find }}
          RUN_FIX: ${{ github.event.inputs.run_fix }}
          COMPONENT: ${{ github.event.inputs.component || 'AI Core Dashboard' }}
        run: |
          PROMPT=""

          # Build prompt based on what steps to run
          if [ "$RUN_FIND" = "true" ] && [ "$RUN_FIX" = "true" ]; then
            # Both find and fix - run automatically without asking
            PROMPT="/cve.find --component '${COMPONENT}'"$'\n\n'"After /cve.find completes, automatically run /cve.fix without asking for confirmation."
          elif [ "$RUN_FIND" = "true" ]; then
            # Only find
            PROMPT="/cve.find --component '${COMPONENT}'"
          elif [ "$RUN_FIX" = "true" ]; then
            # Only fix
            PROMPT="/cve.fix"
          fi

          # Save prompt to output (escape for multiline)
          {
            echo 'prompt<<EOF'
            echo "$PROMPT"
            echo EOF
          } >> $GITHUB_OUTPUT

          echo "### ðŸ“ Session Prompt" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$PROMPT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Run CVE Automation Session
        id: cve-session
        uses: ambient-code/ambient-action@v0.0.2
        with:
          api-url: ${{ secrets.AMBIENT_API_URL }}
          api-token: ${{ secrets.AMBIENT_API_TOKEN }}
          project: new
          prompt: ${{ steps.build-prompt.outputs.prompt }}
          workflow: |
            {
              "gitUrl": "https://github.com/angaduom/workflows.git",
              "branch": "test-configuration",
              "path": "workflows/cve-fixer"
            }
          display-name: "CVE Automation - ${{ github.event.inputs.component || 'AI Core Dashboard' }} (Run ${{ github.run_id }})"
          timeout: 4500
          wait: true
          poll-interval: 30

      - name: Report Results
        if: always()
        env:
          SESSION_NAME: ${{ steps.cve-session.outputs.session-name }}
          SESSION_UID: ${{ steps.cve-session.outputs.session-uid }}
          SESSION_PHASE: ${{ steps.cve-session.outputs.session-phase }}
          COMPONENT: ${{ github.event.inputs.component || 'AI Core Dashboard' }}
          RUN_FIND: ${{ github.event.inputs.run_find }}
          RUN_FIX: ${{ github.event.inputs.run_fix }}
        run: |
          echo "### ðŸ¤– CVE Automation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Session Name** | \`${SESSION_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Session UID** | \`${SESSION_UID}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Phase** | ${SESSION_PHASE} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Component** | ${COMPONENT} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Repository** | ${{ github.repository }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Find Step** | $([ "$RUN_FIND" = "true" ] && echo "âœ… Enabled" || echo "â­ï¸ Skipped") |" >> $GITHUB_STEP_SUMMARY
          echo "| **Fix Step** | $([ "$RUN_FIX" = "true" ] && echo "âœ… Enabled" || echo "â­ï¸ Skipped") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$SESSION_PHASE" = "Completed" ]; then
            echo "### âœ… Session Completed Successfully" >> $GITHUB_STEP_SUMMARY
            if [ "$RUN_FIX" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… Pull requests may have been created in the repository" >> $GITHUB_STEP_SUMMARY
              echo "âœ… Check the [Pull Requests](https://github.com/${{ github.repository }}/pulls) tab for CVE fixes" >> $GITHUB_STEP_SUMMARY
            fi
            exit 0
          elif [ "$SESSION_PHASE" = "Error" ]; then
            echo "### âŒ Session Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The session encountered an error. Check the Ambient Platform logs for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "$SESSION_PHASE" = "Timeout" ]; then
            echo "### â±ï¸ Session Timed Out" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The session exceeded the timeout limit (75 minutes)." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "### âš ï¸ Unknown Session State" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Session phase: ${SESSION_PHASE}" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
